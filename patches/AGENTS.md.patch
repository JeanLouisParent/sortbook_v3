diff --git a/AGENTS.md b/AGENTS.md
index 24ebacc..a3db0ff 100644
--- a/AGENTS.md
+++ b/AGENTS.md
@@ -4,14 +4,14 @@

 

 - Composants:

   - n8n: workflow orchestrant lÃ”Ã‡Ã–analyse sâ”œÂ®mantique (exposâ”œÂ® via webhook HTTPS).

-  - Agent Python (ce repo): lit les EPUB, extrait texte + mâ”œÂ®tadonnâ”œÂ®es, appelle n8n, journalise et renomme selon la confiance.

+  - Agent Python (ce repo): lit les EPUB, extrait texte + mâ”œÂ®tadonnâ”œÂ®es, appelle n8n et journalise la râ”œÂ®ponse sans modifier les fichiers.

   - Docker Compose: facilite lÃ”Ã‡Ã–orchestration (n8n, agent, Ollama en option).

 

 ## Flux de bout en bout

 

 1) **Extraction :** L'agent Python parcourt les fichiers `.epub` dans le dossier source. Pour chaque EPUB, il extrait :

     *   Du texte brut (environ 4000 caractâ”œÂ¿res par dâ”œÂ®faut, configurable via `DEFAULT_MAX_TEXT_CHARS`), en priorisant les sections comme la couverture ou la page de titre (via `PREFERRED_KEYWORDS`) pour une meilleure pertinence.

-    *   Les mâ”œÂ®tadonnâ”œÂ®es standard de l'EPUB (titre, auteur, â”œÂ®diteur, langue, identifiant, description) â”œÃ¡ partir du fichier OPF.

+    *   Les mâ”œÂ®tadonnâ”œÂ®es standard de l'EPUB (titre, auteur, â”œÂ®diteur, langue, identifiant, description) â”œÃ¡ partir du fichier OPF, puis tente de repâ”œÂ®rer un ISBN 10 ou 13 parmi les identifiants OPF pour l'ajouter au `payload`.

 2) **Communication n8n :** L'agent envoie â”œÃ¡ n8n un `payload` JSON structurâ”œÂ® contenant les informations extraites :

     ```json

     {

@@ -25,38 +25,48 @@

             "publisher": "â”œÃ«diteur OPF",

             "language": "fr",

             "identifier": "urn:isbn:1234567890",

-            "description": "Description OPF"

+            "description": "Description OPF",

+            "isbn": "9781234567897",

+            "dc:subject": ["Roman", "Fantastique"],

+            "meta:cover": "cover.jpg"

         }

     }

     ```

-3) **Râ”œÂ®ponse n8n et Normalisation :** n8n effectue son analyse (gâ”œÂ®nâ”œÂ®ralement via un LLM) et renvoie une râ”œÂ®ponse. L'agent Python (via la fonction `_normalize_n8n_response`) est flexible et peut interprâ”œÂ®ter plusieurs formats de râ”œÂ®ponse pour en extraire un `EpubResult` (titre, auteur, confiance, explication). Les formats gâ”œÂ®râ”œÂ®s incluent :

-    *   **Format direct (recommandâ”œÂ®) :** `{"titre": "...", "auteur": "...", "confiance": "0.95", "explication": "..."}`

-    *   **Format encapsulâ”œÂ® :** `{"output": {"titre": "...", "auteur": "...", ...}}`

-    *   **Format liste :** `[{"titre": "...", "auteur": "...", ...}]` ou `[{"output": {"titre": "...", ...}}]`

-    *   Les clâ”œÂ®s `title` et `author` sont automatiquement remappâ”œÂ®es vers `titre` et `auteur` si elles sont prâ”œÂ®sentes.

-    En mode `test`, la râ”œÂ®ponse brute de n8n est affichâ”œÂ®e et aucune normalisation n'est tentâ”œÂ®e.

-4) **Log et Renommage Conditionnel :**

-    *   L'agent journalise systâ”œÂ®matiquement une ligne JSONL par fichier traitâ”œÂ® dans `EPUB_LOG_FILE`, incluant toutes les donnâ”œÂ®es du `payload`, la râ”œÂ®ponse normalisâ”œÂ®e de n8n et le chemin de destination.

-    *   Le renommage est proposâ”œÂ®/effectuâ”œÂ® uniquement si :

-        *   Le `titre` renvoyâ”œÂ® par n8n n'est pas "inconnu" (insensible â”œÃ¡ la casse).

-        *   La `confiance` renvoyâ”œÂ®e par n8n (convertie en float) est supâ”œÂ®rieure ou â”œÂ®gale â”œÃ¡ `CONFIDENCE_MIN` (dâ”œÂ®fini par une variable d'environnement ou l'argument CLI `--confidence-min`).

-    *   Le nouveau nom de fichier est gâ”œÂ®nâ”œÂ®râ”œÂ® via `slugify` (max 150 caractâ”œÂ¿res par dâ”œÂ®faut, configurable via `DEFAULT_SLUG_MAX_LENGTH`), et gâ”œÂ¿re les conflits de noms en ajoutant un suffixe numâ”œÂ®rique (ex: `(1)`).

+3) **Râ”œÂ®ponse n8n et Normalisation :** n8n renvoie dâ”œÂ®sormais une liste d'objets `<metadata>` (ex: `title`, `creator`, `identifier`, `publisher`, `date`). L'agent Python (via `_normalize_n8n_response`) râ”œÂ®cupâ”œÂ¿re le premier objet utile, remappe `title`/`creator` en `titre`/`auteur` et conserve le reste des champs dans `metadata` pour les logs.

+    *   Le format attendu ressemble â”œÃ¡ l'exemple suivant :

+        ```json

+        [

+            {

+                "title": "L'Epâ”œÂ®e de Shannara",

+                "creator": "Terry Brooks",

+                "identifier": [

+                    {"type": "ISBN_10", "identifier": "2290325872"},

+                    {"type": "ISBN_13", "identifier": "9782290325872"}

+                ],

+                "language": null,

+                "date": "Apr 05, 2005",

+                "publisher": "J'ai lu"

+            }

+        ]

+        ```

+    *   En mode `test`, la râ”œÂ®ponse brute de n8n est affichâ”œÂ®e et loguâ”œÂ®e sans renommer les fichiers.

+4) **Log :**

+    *   L'agent journalise une ligne JSONL par fichier traitâ”œÂ® dans `EPUB_LOG_FILE`, incluant le `payload`, le `epub_metadata`, la râ”œÂ®ponse normalisâ”œÂ®e (`result`) et le chemin de destination.

+    *   Aucune modification n'est faite sur les fichiers stockâ”œÂ®s, le script reste en lecture seule.

 

 ## Râ”œÂ®partition des fichiers

 

 -   `src/epub_metadata.py` (script principal)

     -   **Dataclasses clâ”œÂ®s :**

-        -   `Config` : Gâ”œÂ¿re le chargement de la configuration depuis les variables d'environnement et les arguments CLI. Contient `webhook_url`, `verify_ssl`, `timeout`, `log_path`, `epub_root_label`, `dest_path`, `confidence_min`.

-        -   `EpubResult` : Reprâ”œÂ®sente la râ”œÂ®ponse normalisâ”œÂ®e de n8n, avec `titre`, `auteur`, `confiance`, `explication`. Inclut la logique `get_confidence_value` et `should_rename` pour le renommage conditionnel.

-        -   `EpubMetadata` : Contient les mâ”œÂ®tadonnâ”œÂ®es extraites directement du fichier OPF de l'EPUB (`title`, `creator`, `publisher`, `language`, `identifier`, `description`).

+        -   `Config` : Gâ”œÂ¿re le chargement de la configuration depuis les variables d'environnement et les arguments CLI. Contient `webhook_url`, `verify_ssl`, `timeout`, `log_path`, `epub_root_label` et `dest_path`.

+    -   `EpubResult` : Reprâ”œÂ®sente la râ”œÂ®ponse normalisâ”œÂ®e de n8n, avec `titre`, `auteur` et un `metadata` contenant les autres champs (date, identifier...) fournis par le workflow.

+    -   `EpubMetadata` : Contient les mâ”œÂ®tadonnâ”œÂ®es extraites directement du fichier OPF de l'EPUB (`title`, `creator`, `publisher`, `language`, `identifier`, `description`), conserve la liste des identifiants pour dâ”œÂ®tecter un ISBN 10 ou 13 et mâ”œÂ®morise toutes les autres clâ”œÂ®s prâ”œÂ®sentes dans `<metadata>` pour les inclure dans le `payload`.

     -   **Fonctions clâ”œÂ®s :**

         -   `extract_text_from_epub(epub_path, max_chars)` : Extrait le texte nettoyâ”œÂ® de l'EPUB en priorisant les sections pertinentes (`PREFERRED_KEYWORDS`). Limite l'extraction â”œÃ¡ `max_chars` (par dâ”œÂ®faut `DEFAULT_MAX_TEXT_CHARS = 4000`).

         -   `extract_metadata_from_epub(epub_path)` : Lit les mâ”œÂ®tadonnâ”œÂ®es Dublin Core du fichier OPF de l'EPUB et les renvoie sous forme d'objet `EpubMetadata`.

         -   `call_n8n(payload, config, test_mode)` : Envoie le `payload` JSON â”œÃ¡ l'URL de webhook n8n configurâ”œÂ®e. Gâ”œÂ¿re les diffâ”œÂ®rents formats de râ”œÂ®ponse de n8n via `_normalize_n8n_response` pour les convertir en un format `EpubResult` cohâ”œÂ®rent.

-        -   `slugify(text, max_length)` : Crâ”œÂ®e un nom de fichier sâ”œâ•—r et nettoyâ”œÂ® â”œÃ¡ partir d'une chaâ”œÂ«ne de caractâ”œÂ¿res, tronquâ”œÂ® â”œÃ¡ `max_length` (par dâ”œÂ®faut `DEFAULT_SLUG_MAX_LENGTH = 150`).

         -   `log_result(...)` : Ajoute un enregistrement JSONL au fichier de log spâ”œÂ®cifiâ”œÂ® par `config.log_path`.

-        -   `rename_epub(...)` : Renomme l'EPUB sur le disque en fonction du titre et de l'auteur dâ”œÂ®terminâ”œÂ®s, avec gestion des conflits de noms.

-        -   `process_epub(...)` : Orchestre l'extraction, l'appel â”œÃ¡ n8n, le logging et le renommage pour un seul fichier EPUB.

+        -   `process_epub(...)` : Orchestre l'extraction, l'appel â”œÃ¡ n8n et le logging pour un seul fichier EPUB.

         -   `process_folder(...)` : Itâ”œÂ¿re sur tous les fichiers EPUB d'un dossier (et de ses sous-dossiers), appelant `process_epub` pour chacun.

 

 -   `doc/usage.md` : Dâ”œÂ®taille l'exâ”œÂ®cution locale/Docker, la configuration TLS, les variables d'environnement spâ”œÂ®cifiques â”œÃ¡ n8n, l'utilisation du mode `--test`, les formats de râ”œÂ®ponse et la gestion des journaux.

@@ -71,13 +81,13 @@

     -   `true`, `1`, `yes`, `oui` (dâ”œÂ®faut) : Active la vâ”œÂ®rification SSL.

     -   Tout autre chemin : Spâ”œÂ®cifie un chemin vers un fichier de certificat CA personnalisâ”œÂ®.

 -   `N8N_TIMEOUT` : Timeout en secondes pour les requâ”œÂ¬tes HTTP vers n8n (par dâ”œÂ®faut `120.0`).

--   `CONFIDENCE_MIN` : Seuil de confiance minimal (float entre 0.0 et 1.0, par dâ”œÂ®faut `0.9`). Si la confiance renvoyâ”œÂ®e par n8n est infâ”œÂ®rieure â”œÃ¡ cette valeur, le renommage est ignorâ”œÂ®. Peut â”œÂ¬tre surchargâ”œÂ® par l'argument CLI `--confidence-min`.

 -   `EPUB_SOURCE_DIR` : Chemin par dâ”œÂ®faut du dossier â”œÃ¡ analyser si non spâ”œÂ®cifiâ”œÂ® via `--folder` ou l'invite utilisateur.

--   `EPUB_DEST` : Chemin de destination par dâ”œÂ®faut pour les EPUB renommâ”œÂ®s (vide par dâ”œÂ®faut, ce qui signifie que les fichiers sont renommâ”œÂ®s sur place).

+-   `EPUB_DEST` : Chemin de destination par dâ”œÂ®faut (inclus dans le `payload` n8n, sans â”œÂ®criture automatique).

 -   `LOG_DIR` : Râ”œÂ®pertoire oâ”œâ•£ sera stockâ”œÂ® le fichier de log JSONL (par dâ”œÂ®faut le râ”œÂ®pertoire courant).

 -   `EPUB_LOG_FILE` : Nom du fichier de log JSONL (par dâ”œÂ®faut `n8n_response.json`).

 -   `DEFAULT_MAX_TEXT_CHARS` : Nombre maximal de caractâ”œÂ¿res â”œÃ¡ extraire du texte de l'EPUB pour l'analyse par n8n (par dâ”œÂ®faut `4000`).

 -   `DEFAULT_SLUG_MAX_LENGTH` : Longueur maximale des slugs gâ”œÂ®nâ”œÂ®râ”œÂ®s pour les noms de fichiers (par dâ”œÂ®faut `150`).

+-   `RUN_EPUB_AGENT` : `true` pour que `epub-agent` lance automatiquement `python src/epub_metadata.py` au dâ”œÂ®marrage ; `false` (par dâ”œÂ®faut) laisse le service en veille afin que tu dâ”œÂ®clenches manuellement le script via `docker compose exec epub-agent ...`.

 

 

 ## Comportement CLI

@@ -85,12 +95,11 @@

 -   `--test` : Active le mode test.

     -   Utilise l'URL de webhook de test (`N8N_WEBHOOK_TEST_URL`).

     -   Affiche la râ”œÂ®ponse brute du webhook (pas d'exigence de format JSON strict).

-    -   N'applique aucun renommage de fichier.

--   `--dry-run` : Simule les renommages. Les fichiers ne sont pas modifiâ”œÂ®s sur le disque, mais les opâ”œÂ®rations sont affichâ”œÂ®es dans la console.

+    -   N'applique aucune modification sur les fichiers.

+-   `--dry-run` : Simule l'appel n8n en lecture seule ; le script affiche la râ”œÂ®ponse sans toucher aux fichiers.

 -   `--folder <path>` : Spâ”œÂ®cifie le dossier â”œÃ¡ traiter. Surcharge la variable d'environnement `EPUB_SOURCE_DIR` et l'invite utilisateur.

--   `--confidence-min <value>` : Surcharge la variable d'environnement `CONFIDENCE_MIN` pour le seuil de confiance minimal requis pour le renommage.

 -   `--limit <n>` : Traite un nombre maximal de `n` fichiers EPUB, puis s'arrâ”œÂ¬te.

--   Sans `--test`, le script exige une râ”œÂ®ponse JSON structurâ”œÂ®e de n8n pour pouvoir extraire les informations de renommage.

+-   Sans `--test`, le script exige une râ”œÂ®ponse JSON structurâ”œÂ®e de n8n pour pouvoir logger les mâ”œÂ®tadonnâ”œÂ®es.

 

 ## Services docker-compose

 

@@ -105,7 +114,7 @@ Le fichier `docker-compose.yml` orchestre les services suivants :

 

 -   **epub-agent** (construit â”œÃ¡ partir du `Dockerfile` local) :

     -   **Dâ”œÂ®pendance :** Dâ”œÂ®marre aprâ”œÂ¿s le service `n8n`.

-    -   **Variables d'environnement :** Râ”œÂ®cupâ”œÂ¿re plusieurs variables de l'environnement hâ”œâ”¤te (ex: `EPUB_ROOT`, `N8N_WEBHOOK_PROD_URL`, `CONFIDENCE_MIN`).

+    -   **Variables d'environnement :** Râ”œÂ®cupâ”œÂ¿re plusieurs variables de l'environnement hâ”œâ”¤te (ex: `EPUB_ROOT`, `N8N_WEBHOOK_PROD_URL`).

     -   **Chemin d'entrâ”œÂ®e des EPUB :** Le script recherche les EPUB dans le râ”œÂ®pertoire `/data` *â”œÃ¡ l'intâ”œÂ®rieur* du conteneur.

     -   **Volumes :**

         -   `${EPUB_ROOT:-./ebooks}:/data:rw` : Monte le râ”œÂ®pertoire local spâ”œÂ®cifiâ”œÂ® par `EPUB_ROOT` (par dâ”œÂ®faut `./ebooks`) dans `/data` du conteneur, permettant â”œÃ¡ l'agent d'accâ”œÂ®der aux fichiers EPUB.

