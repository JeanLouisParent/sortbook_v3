diff --git a/doc/reference.md b/doc/reference.md
index bc0e157..0b702a3 100644
--- a/doc/reference.md
+++ b/doc/reference.md
@@ -5,9 +5,8 @@

 Le script `epub_metadata.py` accepte les arguments suivants :

 

 -   `--folder PATH` : Chemin du dossier contenant les fichiers EPUB â”œÃ¡ traiter. Si non spâ”œÂ®cifiâ”œÂ®, le script utilise la variable d'environnement `EPUB_SOURCE_DIR` ou demande â”œÃ¡ l'utilisateur.

--   `--confidence-min FLOAT` : Seuil de confiance minimal (float entre 0.0 et 1.0) pour le renommage automatique. Surcharge la valeur dâ”œÂ®finie par la variable d'environnement `CONFIDENCE_MIN`.

--   `--dry-run` : Active le mode simulation. Les opâ”œÂ®rations de renommage sont affichâ”œÂ®es dans la console mais aucune modification n'est effectuâ”œÂ®e sur le disque.

--   `--test` : Active le mode test. Le script utilise l'URL de test n8n (`N8N_WEBHOOK_TEST_URL`), affiche la râ”œÂ®ponse brute du webhook et n'effectue aucun renommage.

+-   `--dry-run` : Active le mode simulation. Le script affiche la râ”œÂ®ponse de n8n sans modifier les fichiers EPUB.

+-   `--test` : Active le mode test. Le script utilise l'URL de test n8n (`N8N_WEBHOOK_TEST_URL`), affiche la râ”œÂ®ponse brute du webhook et ne touche pas aux fichiers.

 -   `--limit N` : Limite le traitement aux `N` premiers fichiers EPUB trouvâ”œÂ®s.

 

 Pour des exemples d'utilisation et une description plus dâ”œÂ®taillâ”œÂ®e, consultez la section "Arguments CLI (principaux)" du `README.md`.

@@ -16,8 +15,8 @@ Pour des exemples d'utilisation et une description plus dâ”œÂ®taillâ”œÂ®e, consultez l

 

 ### Dataclasses

 -   `Config`: Classe de configuration de l'application, chargâ”œÂ®e â”œÃ¡ partir des variables d'environnement et des arguments CLI.

--   `EpubResult`: Reprâ”œÂ®sente le râ”œÂ®sultat normalisâ”œÂ® de la râ”œÂ®ponse du webhook n8n (titre, auteur, confiance, explication) et contient la logique de dâ”œÂ®cision de renommage.

--   `EpubMetadata`: Contient les mâ”œÂ®tadonnâ”œÂ®es extraites directement du fichier OPF de l'EPUB.

+-   `EpubResult`: Reprâ”œÂ®sente le râ”œÂ®sultat normalisâ”œÂ® de la râ”œÂ®ponse du webhook n8n (titre, auteur, metadata).

+-   `EpubMetadata`: Contient les mâ”œÂ®tadonnâ”œÂ®es extraites directement du fichier OPF de l'EPUB (`title`, `creator`, `publisher`, `language`, `identifier`, `description`), conserve les identifiants OPF pour dâ”œÂ®tecter un ISBN 10 ou 13, et mâ”œÂ®morise toutes les autres balises/mâ”œÂ®tadonnâ”œÂ®es `<metadata>` pour les inclure dans le payload.

 

 ### Fonctions

 -   `extract_text_from_epub(epub_path: Path, max_chars: int = DEFAULT_MAX_TEXT_CHARS) -> str`

@@ -25,15 +24,17 @@ Pour des exemples d'utilisation et une description plus dâ”œÂ®taillâ”œÂ®e, consultez l

 

 -   `extract_metadata_from_epub(epub_path: Path) -> EpubMetadata`

     -   Parse le fichier OPF interne de l'EPUB et en extrait les mâ”œÂ®tadonnâ”œÂ®es Dublin Core (`title`, `creator`, `publisher`, `language`, `identifier`, `description`) sous forme d'objet `EpubMetadata`.

+    -   Conserve la liste complâ”œÂ¿te de tous les `dc:identifier` pour alimenter la dâ”œÂ®tection d'un ISBN 10 ou 13.

+    -   Stocke â”œÂ®galement toutes les autres balises/metadonnâ”œÂ®es prâ”œÂ®sentes dans `<metadata>` afin de les renvoyer dans le payload.

 

 -   `call_n8n(payload: dict, config: Config, test_mode: bool = False) -> Optional[dict[str, Any]]`

     -   Envoie le `payload` JSON au webhook n8n spâ”œÂ®cifiâ”œÂ® par `config.webhook_url`.

     -   Gâ”œÂ¿re les erreurs de requâ”œÂ¬te (`requests.RequestException`).

     -   En mode `test_mode=True` : Affiche la râ”œÂ®ponse brute du webhook et renvoie `None`.

-    -   En mode normal : Normalise la râ”œÂ®ponse JSON de n8n via `_normalize_n8n_response` pour un format cohâ”œÂ®rent (`dict` avec `titre`, `auteur`, `confiance`, `explication`). Se râ”œÂ®fâ”œÂ®rer â”œÃ¡ `AGENTS.md` pour les formats de râ”œÂ®ponse n8n pris en charge.

+    -   En mode normal : Normalise la premiâ”œÂ¿re entrâ”œÂ®e d'une liste d'objets metadata via `_normalize_n8n_response` pour en extraire `titre`, `auteur` et la totalitâ”œÂ® des autres champs. Se râ”œÂ®fâ”œÂ®rer â”œÃ¡ `AGENTS.md` pour les formats de râ”œÂ®ponse n8n pris en charge.

 

 -   `process_epub(epub_path: Path, config: Config, dry_run: bool = True, test_mode: bool = False) -> None`

-    -   Orchestre le traitement d'un unique fichier EPUB : extrait le texte et les mâ”œÂ®tadonnâ”œÂ®es, construit le `payload`, appelle `call_n8n`, loggue le râ”œÂ®sultat et, en mode normal et si la confiance est suffisante, propose/effectue le renommage.

+    -   Orchestre le traitement d'un unique fichier EPUB : extrait le texte et les mâ”œÂ®tadonnâ”œÂ®es, construit le `payload` (dont le champ `metadata` contient toutes les mâ”œÂ®tadonnâ”œÂ®es OPF extraites, avec `metadata.isbn` lorsque disponible), appelle `call_n8n` et loggue le râ”œÂ®sultat (`result`) sans modifier le fichier.

 

 -   `process_folder(folder: Path, config: Config, dry_run: bool = True, limit: int | None = None, test_mode: bool = False) -> None`

     -   Itâ”œÂ¿re de maniâ”œÂ¿re râ”œÂ®cursive sur tous les fichiers `.epub` dans le `folder` donnâ”œÂ® et appelle `process_epub` pour chacun.

@@ -41,7 +42,7 @@ Pour des exemples d'utilisation et une description plus dâ”œÂ®taillâ”œÂ®e, consultez l

 

 ### Fonctions utilitaires

 -   `slugify(text: str, max_length: int = DEFAULT_SLUG_MAX_LENGTH) -> str`: Nettoie une chaâ”œÂ«ne de caractâ”œÂ¿res pour en faire un nom de fichier sâ”œâ•—r et valide.

--   `log_result(...)`: Ajoute une entrâ”œÂ®e JSONL au fichier de log aprâ”œÂ¿s le traitement d'un EPUB.

+-   `log_result(...)`: Ajoute une entrâ”œÂ®e JSONL au fichier de log aprâ”œÂ¿s le traitement d'un EPUB (incluant la totalitâ”œÂ® de la map `metadata` envoyâ”œÂ®e â”œÃ¡ n8n).

 

 ## Variables dÃ”Ã‡Ã–environnement

 

@@ -52,12 +53,12 @@ Les variables d'environnement sont lues au dâ”œÂ®marrage du script et peuvent â”œÂ¬tre

 -   `N8N_VERIFY_SSL` : Contrâ”œâ”¤le la vâ”œÂ®rification SSL des requâ”œÂ¬tes HTTP vers n8n. Peut â”œÂ¬tre `false` (dâ”œÂ®sactivâ”œÂ®), `true` (activâ”œÂ®, par dâ”œÂ®faut), ou un chemin vers un fichier de certificat CA (`/certs/n8n.crt`).

 -   `N8N_TIMEOUT` : Dâ”œÂ®lai maximum en secondes pour l'appel HTTP au webhook (par dâ”œÂ®faut `120.0`).

 -   `EPUB_SOURCE_DIR` : Chemin par dâ”œÂ®faut du dossier source des EPUB.

--   `EPUB_DEST` : Chemin par dâ”œÂ®faut du dossier de destination des EPUB renommâ”œÂ®s.

+-   `EPUB_DEST` : Chemin par dâ”œÂ®faut du dossier de destination (mentionnâ”œÂ® dans le `payload` de logging).

 -   `LOG_DIR` : Râ”œÂ®pertoire oâ”œâ•£ sera crâ”œÂ®â”œÂ® le fichier de log JSONL.

 -   `EPUB_LOG_FILE` : Nom du fichier de log JSONL.

--   `CONFIDENCE_MIN` : Seuil de confiance minimal (float 0.0-1.0) pour le renommage. Peut â”œÂ¬tre surchargâ”œÂ® par `--confidence-min`.

 -   `DEFAULT_MAX_TEXT_CHARS` : Nombre maximal de caractâ”œÂ¿res â”œÃ¡ extraire de l'EPUB pour l'analyse (par dâ”œÂ®faut `4000`).

 -   `DEFAULT_SLUG_MAX_LENGTH` : Longueur maximale pour les slugs gâ”œÂ®nâ”œÂ®râ”œÂ®s pour les noms de fichiers (par dâ”œÂ®faut `150`).

+-   `RUN_EPUB_AGENT` : `true` pour exâ”œÂ®cuter automatiquement `python src/epub_metadata.py` lors du dâ”œÂ®marrage de `epub-agent`; `false` (par dâ”œÂ®faut) laisse le conteneur en veille afin que tu dâ”œÂ®clenches manuellement le script.

 

 Pour une configuration complâ”œÂ¿te et des exemples, veuillez consulter le `README.md` et `doc/usage.md`.

 

